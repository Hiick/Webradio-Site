<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

<script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>
<script src="{{ asset('vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

<!-- Core plugin JavaScript-->
<script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>

<!-- Custom scripts for all pages-->
<script src="{{ asset('js/sb-admin-2.min.js') }}"></script>
<script>

$(document).ready(function() {

    let firebaseConfig;
    let downloadUrl;

    $.ajax({
    method: "GET", 
    url: "/profile/firebase", 
    async: true,
    success: function(data) {
    //console.log(data.apiKey+" "+data.authDomain+" "+data.databaseURL+" "+data.projectId+" "+data.storageBucket);
    
        firebaseConfig = {
            apiKey: data.apiKey,
            authDomain: data.authDomain,
            databaseURL: data.databaseURL,
            projectId: data.projectId,
            storageBucket: data.storageBucket
        };
        
        firebase.initializeApp(firebaseConfig);

            // On détecte le changement de fichier
    $('#musicInput').on('change', function() {

        // On récupère le nouveau fichier
        let selectedFile = event.target.files[0];

        let filename = $('#musicInput').val().replace(/C:\\fakepath\\/i, '');
        let storageRef = firebase.storage().ref('/User/libray/{{ app.user.id }}' + filename);

            // On envoi le fichier à Firebase
            let upload = storageRef.put(selectedFile);

            // Le traitement Firebase se fait ici
            upload.on('state_changed', function(snapshot) {

            }, function(error) {
                // Si Firebase renvoi une error on l'a met ici
                console.log(error)
            }, function() {
                // On récupère l'URL téléchargeable
                downloadUrl = upload.snapshot.downloadURL;
                // On l'affiche
                 console.log(downloadUrl);

                    $.ajax({
                        method: "POST", 
                        url: "/profile/library/new", 
                        data: JSON.stringify({
                            "filename": filename
                        }),
                        async: true,
                        success: function(response) {
                        
                            console.log("sucess: "+filename);
                        },
                        error: function(error){
                            console.log(error);
                        }

                    });
            });

    });

    }
    });
});

</script>